blueprint:
  name: SOG – Plant soil moisture watering (weather + manual skip + Pushover + frost + root-rot guard)
  description: >
    Waters a plant at a scheduled time when soil moisture is low unless:
    • the manual skip helper is ON,
    • rain or freeze is predicted (OpenWeatherMap hourly),
    • moisture is already above a skip threshold,
    • a recent frost occurred (optional), or
    • the root-rot guard is active (optional: wet-hours and/or drying-rate).
    Sends optional Pushover notifications and can publish an MQTT breadcrumb.
  domain: automation

  input:

    plant_name:
      name: Plant name (for messages)
      default: Plant
      selector:
        text: {}

    moisture_sensor:
      name: Soil moisture sensor
      selector:
        entity:
          domain: sensor

    water_when:
      name: Water when moisture ≤
      description: Percent at/below which watering should start (conservative).
      default: 45
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: '%'
          mode: slider

    skip_above:
      name: Skip when moisture ≥
      description: Percent at/above which watering is skipped.
      default: 55
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: '%'
          mode: slider

    water_script:
      name: Script to run when watering
      selector:
        entity:
          domain: script

    schedule_time:
      name: Time to evaluate / water
      default: '04:00:00'
      selector:
        time: {}

    even_days_only:
      name: Only run on even-numbered days
      default: true
      selector:
        boolean: {}

    owm_entity:
      name: OpenWeatherMap weather entity
      default: weather.openweathermap
      selector:
        entity:
          domain: weather

    rain_threshold:
      name: Rain probability threshold (%)
      default: 45
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: '%'
          mode: slider

    rain_hours:
      name: Rain look-ahead (hours)
      default: 12
      selector:
        number:
          min: 1
          max: 48

    freeze_temp_f:
      name: Freeze temperature (°F)
      default: 36
      selector:
        number:
          min: 0
          max: 60

    freeze_hours:
      name: Freeze look-ahead (hours)
      default: 24
      selector:
        number:
          min: 1
          max: 72

    skip_helper:
      name: Manual skip helper (input_boolean)
      selector:
        entity:
          domain: input_boolean

    # -------- Frost-Occurred (optional) --------
    frost_occurred:
      name: Frost occurred flag (optional, input_boolean)
      description: "Entity ID of the boolean your frost automation turns ON (blank = ignore)."
      default: ''
      selector:
        text: {}

    frost_time:
      name: Frost occurred time (optional, input_datetime)
      description: "Entity ID storing the datetime of the frost event (blank = treat flag alone as recent)."
      default: ''
      selector:
        text: {}

    frost_skip_hours:
      name: Skip watering for this many hours after frost
      default: 12
      selector:
        number:
          min: 1
          max: 48

    # -------- Root-rot guard (optional) --------
    wet_guard_percent:
      name: Root-rot guard – “wet” if moisture ≥
      description: Used by drying-rate guard; also recommended for your wet/binary sensor.
      default: 65
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: '%'
          mode: slider

    wet_hours_sensor:
      name: Wet-hours sensor (history_stats) – optional
      description: Select a sensor that reports total “wet” hours in a recent window (e.g., last 18–24h).
      selector:
        entity:
          domain: sensor

    wet_guard_hours:
      name: Root-rot guard – max wet hours in lookback (if sensor provided)
      default: 12
      selector:
        number:
          min: 1
          max: 48

    rate_sensor:
      name: Drying-rate sensor (derivative %/h) – optional
      description: A derivative of your soil sensor in % per hour (negative values mean drying).
      selector:
        entity:
          domain: sensor

    min_drying_rate:
      name: Root-rot guard – minimum drying rate (%/h)
      description: If moisture ≥ “wet” and rate is above (>-X) we treat it as “not drying”.
      default: 0.2
      selector:
        number:
          min: 0
          max: 5
          step: 0.1
          unit_of_measurement: '%/h'
          mode: slider

    # -------- Notifications / breadcrumbs --------
    pushover_device:
      name: Pushover device (optional; blank = all)
      default: ''
      selector:
        text: {}

    mqtt_topic:
      name: MQTT topic (optional; blank = disable)
      default: ''
      selector:
        text: {}

# ---------- variables ----------
variables:
  plant_name: !input plant_name
  moisture_entity: !input moisture_sensor
  water_when: !input water_when
  skip_above: !input skip_above
  water_script: !input water_script
  schedule_time: !input schedule_time
  even_days_only: !input even_days_only
  owm_entity: !input owm_entity
  rain_threshold: !input rain_threshold
  rain_hours: !input rain_hours
  freeze_temp_f: !input freeze_temp_f
  freeze_hours: !input freeze_hours
  skip_helper: !input skip_helper
  pushover_device: !input pushover_device
  mqtt_topic: !input mqtt_topic

  frost_flag: !input frost_occurred
  frost_time: !input frost_time
  frost_skip_hours: !input frost_skip_hours

  wet_guard_percent: !input wet_guard_percent
  wet_hours_sensor: !input wet_hours_sensor
  wet_guard_hours: !input wet_guard_hours
  rate_sensor: !input rate_sensor
  min_drying_rate: !input min_drying_rate

# ---------- trigger ----------
trigger:
  - platform: time
    at: !input schedule_time

# ---------- conditions ----------
condition:
  - condition: template
    value_template: >
      {% if even_days_only %}
      {{ now().day % 2 == 0 }}
      {% else %}
      true
      {% endif %}

# ---------- actions ----------
action:

  # 1) Manual skip flow
  - choose:
      - conditions:
          - condition: state
            entity_id: !input skip_helper
            state: 'on'
        sequence:
          - service: input_boolean.turn_off
            target:
              entity_id: !input skip_helper

          - choose:
              - conditions: "{{ pushover_device|length > 0 }}"
                sequence:
                  - service: notify.pushover
                    data:
                      title: "{{ plant_name }}: skipped (manual)"
                      message: "Manual skip helper was ON. Skipping once and resetting it to OFF."
                      data: { device: "{{ pushover_device }}" }
            default:
              - service: notify.pushover
                data:
                  title: "{{ plant_name }}: skipped (manual)"
                  message: "Manual skip helper was ON. Skipping once and resetting it to OFF."

          - choose:
              - conditions: "{{ mqtt_topic|length > 0 }}"
                sequence:
                  - service: mqtt.publish
                    data:
                      topic: "{{ mqtt_topic }}"
                      payload: >
                        {{ {'event':'skip_manual','plant':plant_name,'time':now().isoformat()} | tojson }}
          - stop: Manual skip active — aborting.

  # 2) Frost-occurred skip (optional)
  - variables:
      recent_frost: >-
        {% set f = frost_flag %}
        {% if not f or f|length == 0 %}
          false
        {% else %}
          {% set on = is_state(f, 'on') %}
          {% set t_id = frost_time %}
          {% if not on %}
            false
          {% elif t_id and t_id|length > 0 and states(t_id) not in ['unknown','unavailable',''] %}
            {% set t = as_datetime(states(t_id)) %}
            {{ (now() - t) <= timedelta(hours=frost_skip_hours|int) }}
          {% else %}
            true
          {% endif %}
        {% endif %}

  - choose:
      - conditions: "{{ recent_frost }}"
        sequence:
          - choose:
              - conditions: "{{ pushover_device|length > 0 }}"
                sequence:
                  - service: notify.pushover
                    data:
                      title: "{{ plant_name }}: skipped (recent frost)"
                      message: >
                        Skipping for {{ frost_skip_hours }}h after frost event.
                      data: { device: "{{ pushover_device }}" }
            default:
              - service: notify.pushover
                data:
                  title: "{{ plant_name }}: skipped (recent frost)"
                  message: "Skipping for {{ frost_skip_hours }}h after frost event."
          - choose:
              - conditions: "{{ mqtt_topic|length > 0 }}"
                sequence:
                  - service: mqtt.publish
                    data:
                      topic: "{{ mqtt_topic }}"
                      payload: >
                        {{ {'event':'skip_frost','plant':plant_name,'time':now().isoformat()} | tojson }}
          - stop: Recent frost — aborting.

  # 3) Root-rot guard (optional: wet-hours and/or drying-rate)
  - variables:
      moist: "{{ states(moisture_entity) | float(0) }}"
      hrs: >-
        {% if wet_hours_sensor is defined and wet_hours_sensor %}
          {{ states(wet_hours_sensor) | float(0) }}
        {% else %} 0 {% endif %}
      stuck_wet_hours: >-
        {% if wet_hours_sensor is defined and wet_hours_sensor %}
          {{ hrs > (wet_guard_hours | float(12)) }}
        {% else %} false {% endif %}
      rate: >-
        {% if rate_sensor is defined and rate_sensor %}
          {{ states(rate_sensor) | float(0) }}
        {% else %} 0 {% endif %}
      stuck_rate: >-
        {% if rate_sensor is defined and rate_sensor %}
          {{ (moist >= wet_guard_percent | float(65)) and (rate > -(min_drying_rate | float(0.2))) }}
        {% else %} false {% endif %}
      root_guard: "{{ stuck_wet_hours or stuck_rate }}"

  - choose:
      - conditions: "{{ root_guard }}"
        sequence:
          - variables:
              reason: >-
                {% if stuck_wet_hours %}wet_hours>{% endif %}
                {% if stuck_rate %}{{ ' ' if stuck_wet_hours else '' }}no_drying{% endif %}
          - choose:
              - conditions: "{{ pushover_device|length > 0 }}"
                sequence:
                  - service: notify.pushover
                    data:
                      title: "{{ plant_name }}: skipped (root-rot guard)"
                      message: >
                        Moisture {{ '%.0f'|format(moist) }}%. Guard reason: {{ reason|trim }}.
                        Check drainage/mix; skipping to avoid waterlogging.
                      data: { device: "{{ pushover_device }}" }
            default:
              - service: notify.pushover
                data:
                  title: "{{ plant_name }}: skipped (root-rot guard)"
                  message: >
                    Moisture {{ '%.0f'|format(moist) }}%. Guard reason: {{ reason|trim }}.
                    Check drainage/mix; skipping to avoid waterlogging.
          - choose:
              - conditions: "{{ mqtt_topic|length > 0 }}"
                sequence:
                  - service: mqtt.publish
                    data:
                      topic: "{{ mqtt_topic }}"
                      payload: >
                        {{ {'event':'skip_root_guard','plant':plant_name,'moisture':moist,
                            'hours':hrs,'rate':rate,'time':now().isoformat()} | tojson }}
          - stop: Root-rot guard active — aborting.

  # 4) Get OWM hourly forecast
  - service: weather.get_forecasts
    target:
      entity_id: !input owm_entity
    data:
      type: hourly
    response_variable: owm

  # 5) Build windows + read moisture (moist already set)
  - variables:
      fc: "{{ (owm[owm_entity].forecast if owm and owm.get(owm_entity) else []) }}"
      start: "{{ now().isoformat() }}"
      rain_end: "{{ (now() + timedelta(hours=rain_hours)).isoformat() }}"
      freeze_end: "{{ (now() + timedelta(hours=freeze_hours)).isoformat() }}"
      rainy: >-
        {{ fc | selectattr('datetime','>=', start)
              | selectattr('datetime','<=', rain_end)
              | selectattr('precipitation_probability','defined')
              | selectattr('precipitation_probability','>=', rain_threshold)
              | list }}
      freezing: >-
        {{ fc | selectattr('datetime','>=', start)
              | selectattr('datetime','<=', freeze_end)
              | selectattr('temperature','<=', freeze_temp_f)
              | list }}

  # 6) Decide
  - choose:
      # Water: low moisture and clear weather
      - conditions:
          - condition: template
            value_template: >
              {{ (moist <= water_when) and (rainy | length == 0) and (freezing | length == 0) }}
        sequence:
          - service: script.turn_on
            target:
              entity_id: !input water_script
          - choose:
              - conditions: "{{ pushover_device|length > 0 }}"
                sequence:
                  - service: notify.pushover
                    data:
                      title: "{{ plant_name }}: watering"
                      message: >
                        Soil {{ '%.0f'|format(moist) }}%. No rain ≥{{ rain_threshold }}% next
                        {{ rain_hours }}h and no freeze ≤{{ freeze_temp_f }}°F next
                        {{ freeze_hours }}h (OWM).
                      data: { device: "{{ pushover_device }}" }
            default:
              - service: notify.pushover
                data:
                  title: "{{ plant_name }}: watering"
                  message: >
                    Soil {{ '%.0f'|format(moist) }}%. No rain ≥{{ rain_threshold }}% next
                    {{ rain_hours }}h and no freeze ≤{{ freeze_temp_f }}°F next
                    {{ freeze_hours }}h (OWM).
          - choose:
              - conditions: "{{ mqtt_topic|length > 0 }}"
                sequence:
                  - service: mqtt.publish
                    data:
                      topic: "{{ mqtt_topic }}"
                      payload: >
                        {{ {'event':'water','plant':plant_name,'moisture':moist,
                            'time':now().isoformat()} | tojson }}

      # Skip (wet or guarded by weather)
      - conditions: []
        sequence:
          - variables:
              r: "{{ rainy|first if rainy|length>0 else none }}"
              f: "{{ freezing|first if freezing|length>0 else none }}"
          - choose:
              - conditions: "{{ pushover_device|length > 0 }}"
                sequence:
                  - service: notify.pushover
                    data:
                      title: "{{ plant_name }}: skipped"
                      message: >
                        {{- 'Soil ' ~ ('%.0f'|format(moist)) ~ '%. ' -}}
                        {%- if moist >= skip_above -%}
                          Already ≥{{ skip_above }}% (wet).
                        {%- elif r is not none -%}
                          Rain ≥{{ rain_threshold }}% expected at {{ as_local(as_datetime(r.datetime)) }}
                          ({{ r.precipitation_probability }}%).
                        {%- elif f is not none -%}
                          Freeze ≤{{ freeze_temp_f }}°F expected at {{ as_local(as_datetime(f.datetime)) }}
                          ({{ f.temperature }}°F).
                        {%- else -%}
                          Weather guard active.
                        {%- endif -%}
                      data: { device: "{{ pushover_device }}" }
            default:
              - service: notify.pushover
                data:
                  title: "{{ plant_name }}: skipped"
                  message: >
                    {{- 'Soil ' ~ ('%.0f'|format(moist)) ~ '%. ' -}}
                    {%- if moist >= skip_above -%}
                      Already ≥{{ skip_above }}% (wet).
                    {%- elif r is not none -%}
                      Rain ≥{{ rain_threshold }}% expected at {{ as_local(as_datetime(r.datetime)) }}
                      ({{ r.precipitation_probability }}%).
                    {%- elif f is not none -%}
                      Freeze ≤{{ freeze_temp_f }}°F expected at {{ as_local(as_datetime(f.datetime)) }}
                      ({{ f.temperature }}°F).
                    {%- else -%}
                      Weather guard active.
                    {%- endif -%}
          - choose:
              - conditions: "{{ mqtt_topic|length > 0 }}"
                sequence:
                  - service: mqtt.publish
                    data:
                      topic: "{{ mqtt_topic }}"
                      payload: >
                        {{ {'event':'skip','plant':plant_name,'moisture':moist,
                            'reason': ( 'already_wet' if moist >= skip_above
                                       else 'rain_soon' if r is not none
                                       else 'freeze_soon' if f is not none
                                       else 'guarded'),
                            'time':now().isoformat()} | tojson }}

mode: single
